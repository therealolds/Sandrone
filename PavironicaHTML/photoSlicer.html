<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Photo Slicer · Pavironica</title>
    <script>(function(){try{const t=localStorage.getItem('theme'); if(t==='light')document.documentElement.setAttribute('data-theme','light');}catch(e){}})();</script>
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans"; }
      header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
      header a { color: var(--muted); text-decoration: none; border: 1px solid var(--border); padding: 6px 10px; border-radius: 8px; }
      header a:hover { border-color: var(--accent); color: var(--text); }
      header h1 { margin: 0; font-size: 18px; letter-spacing: 0.2px; }
      main { padding: 20px; max-width: clamp(1100px, 95vw, 1800px); margin: 0 auto; display: grid; gap: 16px; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
      .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      label { font-size: 12px; color: var(--muted); }
      input[type="file"] { width: 100%; }
      input[type="number"], select { background: var(--input); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; }
      .btn { background: linear-gradient(90deg, var(--accent), var(--accent-2)); border: none; color: #002b36; font-weight: 600; padding: 8px 14px; border-radius: 8px; cursor: pointer; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .muted { color: var(--muted); }
      .result { background: var(--result); border: 1px solid var(--border); border-radius: 10px; padding: 12px; font-size: 12px; }
      .thumbs { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
      .thumb { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: #000; display: grid; place-items: center; }
      .thumb img { width: 100%; height: auto; display: block; }
    </style>
  </head>
  <body>
    <header>
      <a href="../index.html">← Back</a>
      <h1>Photo Slicer</h1>
      <span class="muted">Local-only · No uploads</span>
    </header>
    <main>
      <div class="card">
        <div class="controls" style="justify-content: space-between; margin-bottom: 8px;">
          <label>Image file
            <input id="file" type="file" accept="image/jpeg,image/png,.jpg,.jpeg,.png,.tif,.tiff" />
          </label>
          <label>Splits (k)
            <input id="splits" type="number" min="1" value="3" />
          </label>
          <label>Format
            <select id="format">
              <option value="auto" selected>auto (keep original if possible)</option>
              <option value="jpeg">JPEG</option>
              <option value="png">PNG</option>
            </select>
          </label>
          <label><input id="square" type="checkbox" /> Force square (1:1)</label>
          <label>Align
            <select id="align">
              <option value="left">Left</option>
              <option value="center" selected>Center</option>
              <option value="right">Right</option>
            </select>
          </label>
          <label id="q-wrap">JPEG quality
            <input id="quality" type="range" min="0.5" max="1" step="0.01" value="0.92" />
          </label>
          <button id="btn" class="btn">Slice and download</button>
        </div>
        <div id="status" class="muted">Choose an image to begin.</div>
      </div>

      <div class="card result">
        <div class="muted" style="margin-bottom:8px;">Preview (scaled)</div>
        <div id="thumbs" class="thumbs"></div>
      </div>
    </main>

    <script type="module">
      import { sliceImageFile, sliceAndDownload } from "../PavironicaJS/photoSlicer.js";

      const file = document.getElementById('file');
      const splits = document.getElementById('splits');
      const format = document.getElementById('format');
      const square = document.getElementById('square');
      const align = document.getElementById('align');
      const quality = document.getElementById('quality');
      const qWrap = document.getElementById('q-wrap');
      const btn = document.getElementById('btn');
      const status = document.getElementById('status');
      const thumbs = document.getElementById('thumbs');

      function currentOpts() {
        return {
          format: format.value,
          quality: parseFloat(quality.value) || 0.92,
          square: !!square.checked,
          align: align.value || 'center',
        };
      }

      function setStatus(text) {
        status.textContent = text;
      }

      function toggleQualityVisibility() {
        const f = format.value;
        qWrap.style.display = (f === 'jpeg') ? '' : 'none';
      }
      toggleQualityVisibility();
      format.addEventListener('change', toggleQualityVisibility);
      function toggleAlignVisibility() {
        align.disabled = !square.checked;
      }
      toggleAlignVisibility();
      square.addEventListener('change', () => { toggleAlignVisibility(); renderPreview(); });
      align.addEventListener('change', renderPreview);

      async function renderPreview() {
        thumbs.innerHTML = '';
        const f = file.files?.[0];
        if (!f) return;
        const k = Math.max(1, parseInt(splits.value, 10) || 1);
        setStatus('Preparing preview...');
        btn.disabled = true;
        try {
          const parts = await sliceImageFile(f, k, { ...currentOpts() });
          for (const p of parts) {
            const url = URL.createObjectURL(p.blob);
            const div = document.createElement('div');
            div.className = 'thumb';
            const img = document.createElement('img');
            img.src = url;
            img.alt = p.filename;
            div.appendChild(img);
            thumbs.appendChild(div);
            img.onload = () => { URL.revokeObjectURL(url); };
          }
          setStatus(`Ready: ${parts.length} slice(s).`);
        } catch (e) {
          console.error(e);
          setStatus((e && e.message) ? e.message : String(e));
        } finally {
          btn.disabled = false;
        }
      }

      file.addEventListener('change', renderPreview);
      splits.addEventListener('change', renderPreview);
      format.addEventListener('change', renderPreview);
      quality.addEventListener('input', () => { if (format.value === 'jpeg') renderPreview(); });

      btn.addEventListener('click', async () => {
        const f = file.files?.[0];
        if (!f) { alert('Please choose an image file.'); return; }
        const k = Math.max(1, parseInt(splits.value, 10) || 1);
        setStatus('Slicing and downloading...');
        btn.disabled = true;
        try {
          const count = await sliceAndDownload(f, k, { ...currentOpts() });
          setStatus(`Downloaded ${count} file(s).`);
        } catch (e) {
          console.error(e);
          setStatus((e && e.message) ? e.message : String(e));
        } finally {
          btn.disabled = false;
        }
      });

      // Helpful note for TIFF
      file.addEventListener('change', () => {
        const f = file.files?.[0];
        if (!f) return;
        if (/\.tif{1,2}$/i.test(f.name) || (f.type || '').toLowerCase() === 'image/tiff') {
          setStatus('Note: TIFF support in browsers is limited. If preview fails, convert to PNG/JPEG or we can add a TIFF decoder library.');
        }
      });
    </script>
  </body>
  </html>
